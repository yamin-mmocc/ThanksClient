const safeSelector=e=>{const t=[];let o,s=0;return{content:o=(e=e.replace(/(\[[^\]]*\])/g,(e,o)=>{const l=`__ph-${s}__`;return t.push(o),s++,l})).replace(/(:nth-[-\w]+)(\([^)]+\))/g,(e,o,l)=>{const c=`__ph-${s}__`;return t.push(l),s++,o+c}),placeholders:t}},restoreSafeSelector=(e,t)=>t.replace(/__ph-(\d+)__/g,(t,o)=>e[+o]),_polyfillHost="-shadowcsshost",_polyfillSlotted="-shadowcssslotted",_polyfillHostContext="-shadowcsscontext",_parenSuffix=")(?:\\(((?:\\([^)(]*\\)|[^)(]*)+?)\\))?([^,{]*)",_cssColonHostRe=new RegExp("(-shadowcsshost"+_parenSuffix,"gim"),_cssColonHostContextRe=new RegExp("(-shadowcsscontext"+_parenSuffix,"gim"),_cssColonSlottedRe=new RegExp("(-shadowcssslotted"+_parenSuffix,"gim"),_polyfillHostNoCombinator="-shadowcsshost-no-combinator",_polyfillHostNoCombinatorRe=/-shadowcsshost-no-combinator([^\s]*)/,_shadowDOMSelectorsRe=[/::shadow/g,/::content/g],_selectorReSuffix="([>\\s~+[.,{:][\\s\\S]*)?$",_polyfillHostRe=/-shadowcsshost/gim,_colonHostRe=/:host/gim,_colonSlottedRe=/::slotted/gim,_colonHostContextRe=/:host-context/gim,_commentRe=/\/\*\s*[\s\S]*?\*\//g,stripComments=e=>e.replace(_commentRe,""),_commentWithHashRe=/\/\*\s*#\s*source(Mapping)?URL=[\s\S]+?\*\//g,extractCommentsWithHash=e=>e.match(_commentWithHashRe)||[],_ruleRe=/(\s*)([^;\{\}]+?)(\s*)((?:{%BLOCK%}?\s*;?)|(?:\s*;))/g,_curlyRe=/([{}])/g,OPEN_CURLY="{",CLOSE_CURLY="}",BLOCK_PLACEHOLDER="%BLOCK%",processRules=(e,t)=>{const o=escapeBlocks(e);let s=0;return o.escapedString.replace(_ruleRe,(...e)=>{const l=e[2];let c="",r=e[4],n="";r&&r.startsWith("{%BLOCK%")&&(c=o.blocks[s++],r=r.substring("%BLOCK%".length+1),n="{");const p=t({selector:l,content:c});return`${e[1]}${p.selector}${e[3]}${n}${p.content}${r}`})},escapeBlocks=e=>{const t=e.split(_curlyRe),o=[],s=[];let l=0,c=[];for(let e=0;e<t.length;e++){const r=t[e];"}"===r&&l--,l>0?c.push(r):(c.length>0&&(s.push(c.join("")),o.push("%BLOCK%"),c=[]),o.push(r)),"{"===r&&l++}return c.length>0&&(s.push(c.join("")),o.push("%BLOCK%")),{escapedString:o.join(""),blocks:s}},insertPolyfillHostInCssText=e=>e=e.replace(_colonHostContextRe,"-shadowcsscontext").replace(_colonHostRe,_polyfillHost).replace(_colonSlottedRe,_polyfillSlotted),convertColonRule=(e,t,o)=>e.replace(t,(...e)=>{if(e[2]){const t=e[2].split(","),s=[];for(let l=0;l<t.length;l++){const c=t[l].trim();if(!c)break;s.push(o(_polyfillHostNoCombinator,c,e[3]))}return s.join(",")}return _polyfillHostNoCombinator+e[3]}),colonHostPartReplacer=(e,t,o)=>e+t.replace(_polyfillHost,"")+o,convertColonHost=e=>convertColonRule(e,_cssColonHostRe,colonHostPartReplacer),colonHostContextPartReplacer=(e,t,o)=>t.indexOf(_polyfillHost)>-1?colonHostPartReplacer(e,t,o):e+t+o+", "+t+" "+e+o,convertColonSlotted=(e,t)=>{const o="."+t+" > ",s=[];return e=e.replace(_cssColonSlottedRe,(...e)=>{if(e[2]){const t=e[2].trim(),l=e[3],c=o+t+l;let r="";for(let t=e[4]-1;t>=0;t--){const o=e[5][t];if("}"===o||","===o)break;r=o+r}const n=r+c,p=`${r.trimRight()}${c.trim()}`;if(n.trim()!==p.trim()){const e=`${p}, ${n}`;s.push({orgSelector:n,updatedSelector:e})}return c}return _polyfillHostNoCombinator+e[3]}),{selectors:s,cssText:e}},convertColonHostContext=e=>convertColonRule(e,_cssColonHostContextRe,colonHostContextPartReplacer),convertShadowDOMSelectors=e=>_shadowDOMSelectorsRe.reduce((e,t)=>e.replace(t," "),e),makeScopeMatcher=e=>{return e=e.replace(/\[/g,"\\[").replace(/\]/g,"\\]"),new RegExp("^("+e+")"+_selectorReSuffix,"m")},selectorNeedsScoping=(e,t)=>{return!makeScopeMatcher(t).test(e)},applySimpleSelectorScope=(e,t,o)=>{if(_polyfillHostRe.lastIndex=0,_polyfillHostRe.test(e)){const t=`.${o}`;return e.replace(_polyfillHostNoCombinatorRe,(e,o)=>o.replace(/([^:]*)(:*)(.*)/,(e,o,s,l)=>o+t+s+l)).replace(_polyfillHostRe,t+" ")}return t+" "+e},applyStrictSelectorScope=(e,t,o)=>{const s="."+(t=t.replace(/\[is=([^\]]*)\]/g,(e,...t)=>t[0])),l=e=>{let l=e.trim();if(!l)return"";if(e.indexOf(_polyfillHostNoCombinator)>-1)l=applySimpleSelectorScope(e,t,o);else{const t=e.replace(_polyfillHostRe,"");if(t.length>0){const e=t.match(/([^:]*)(:*)(.*)/);e&&(l=e[1]+s+e[2]+e[3])}}return l},c=safeSelector(e);let r,n="",p=0;const i=/( |>|\+|~(?!=))\s*/g;let a=!((e=c.content).indexOf(_polyfillHostNoCombinator)>-1);for(;null!==(r=i.exec(e));){const t=r[1],o=e.slice(p,r.index).trim();n+=`${(a=a||o.indexOf(_polyfillHostNoCombinator)>-1)?l(o):o} ${t} `,p=i.lastIndex}const h=e.substring(p);return n+=(a=a||h.indexOf(_polyfillHostNoCombinator)>-1)?l(h):h,restoreSafeSelector(c.placeholders,n)},scopeSelector=(e,t,o,s)=>e.split(",").map(e=>s&&e.indexOf("."+s)>-1?e.trim():selectorNeedsScoping(e,t)?applyStrictSelectorScope(e,t,o).trim():e.trim()).join(", "),scopeSelectors=(e,t,o,s,l)=>processRules(e,e=>{let l=e.selector,c=e.content;return"@"!==e.selector[0]?l=scopeSelector(e.selector,t,o,s):(e.selector.startsWith("@media")||e.selector.startsWith("@supports")||e.selector.startsWith("@page")||e.selector.startsWith("@document"))&&(c=scopeSelectors(e.content,t,o,s)),{selector:l.replace(/\s{2,}/g," ").trim(),content:c}}),scopeCssText=(e,t,o,s,l)=>{e=insertPolyfillHostInCssText(e),e=convertColonHost(e),e=convertColonHostContext(e);const c=convertColonSlotted(e,s);return e=c.cssText,e=convertShadowDOMSelectors(e),t&&(e=scopeSelectors(e,t,o,s)),{cssText:(e=(e=e.replace(/-shadowcsshost-no-combinator/g,`.${o}`)).replace(/>\s*\*\s+([^{, ]+)/gm," $1 ")).trim(),slottedSelectors:c.selectors}},scopeCss=(e,t,o)=>{const s=t+"-h",l=t+"-s",c=extractCommentsWithHash(e);e=stripComments(e);const r=[];if(o){const t=e=>{const t=`/*!@___${r.length}___*/`,o=`/*!@${e.selector}*/`;return r.push({placeholder:t,comment:o}),e.selector=t+e.selector,e};e=processRules(e,e=>"@"!==e.selector[0]?t(e):e.selector.startsWith("@media")||e.selector.startsWith("@supports")||e.selector.startsWith("@page")||e.selector.startsWith("@document")?(e.content=processRules(e.content,t),e):e)}const n=scopeCssText(e,t,s,l);return e=[n.cssText,...c].join("\n"),o&&r.forEach(({placeholder:t,comment:o})=>{e=e.replace(t,o)}),n.slottedSelectors.forEach(t=>{e=e.replace(t.orgSelector,t.updatedSelector)}),e};export{scopeCss};