var __spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,t=0,o=arguments.length;t<o;t++)e+=arguments[t].length;var r=Array(e),n=0;for(t=0;t<o;t++)for(var s=arguments[t],l=0,c=s.length;l<c;l++,n++)r[n]=s[l];return r},safeSelector=function(e){var t=[],o=0;return{content:(e=e.replace(/(\[[^\]]*\])/g,function(e,r){var n="__ph-"+o+"__";return t.push(r),o++,n})).replace(/(:nth-[-\w]+)(\([^)]+\))/g,function(e,r,n){var s="__ph-"+o+"__";return t.push(n),o++,r+s}),placeholders:t}},restoreSafeSelector=function(e,t){return t.replace(/__ph-(\d+)__/g,function(t,o){return e[+o]})},_polyfillHost="-shadowcsshost",_polyfillSlotted="-shadowcssslotted",_polyfillHostContext="-shadowcsscontext",_parenSuffix=")(?:\\(((?:\\([^)(]*\\)|[^)(]*)+?)\\))?([^,{]*)",_cssColonHostRe=new RegExp("("+_polyfillHost+_parenSuffix,"gim"),_cssColonHostContextRe=new RegExp("("+_polyfillHostContext+_parenSuffix,"gim"),_cssColonSlottedRe=new RegExp("("+_polyfillSlotted+_parenSuffix,"gim"),_polyfillHostNoCombinator=_polyfillHost+"-no-combinator",_polyfillHostNoCombinatorRe=/-shadowcsshost-no-combinator([^\s]*)/,_shadowDOMSelectorsRe=[/::shadow/g,/::content/g],_selectorReSuffix="([>\\s~+[.,{:][\\s\\S]*)?$",_polyfillHostRe=/-shadowcsshost/gim,_colonHostRe=/:host/gim,_colonSlottedRe=/::slotted/gim,_colonHostContextRe=/:host-context/gim,_commentRe=/\/\*\s*[\s\S]*?\*\//g,stripComments=function(e){return e.replace(_commentRe,"")},_commentWithHashRe=/\/\*\s*#\s*source(Mapping)?URL=[\s\S]+?\*\//g,extractCommentsWithHash=function(e){return e.match(_commentWithHashRe)||[]},_ruleRe=/(\s*)([^;\{\}]+?)(\s*)((?:{%BLOCK%}?\s*;?)|(?:\s*;))/g,_curlyRe=/([{}])/g,OPEN_CURLY="{",CLOSE_CURLY="}",BLOCK_PLACEHOLDER="%BLOCK%",processRules=function(e,t){var o=escapeBlocks(e),r=0;return o.escapedString.replace(_ruleRe,function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var s=e[2],l="",c=e[4],i="";c&&c.startsWith("{"+BLOCK_PLACEHOLDER)&&(l=o.blocks[r++],c=c.substring(BLOCK_PLACEHOLDER.length+1),i="{");var a=t({selector:s,content:l});return""+e[1]+a.selector+e[3]+i+a.content+c})},escapeBlocks=function(e){for(var t=e.split(_curlyRe),o=[],r=[],n=0,s=[],l=0;l<t.length;l++){var c=t[l];c===CLOSE_CURLY&&n--,n>0?s.push(c):(s.length>0&&(r.push(s.join("")),o.push(BLOCK_PLACEHOLDER),s=[]),o.push(c)),c===OPEN_CURLY&&n++}return s.length>0&&(r.push(s.join("")),o.push(BLOCK_PLACEHOLDER)),{escapedString:o.join(""),blocks:r}},insertPolyfillHostInCssText=function(e){return e=e.replace(_colonHostContextRe,_polyfillHostContext).replace(_colonHostRe,_polyfillHost).replace(_colonSlottedRe,_polyfillSlotted)},convertColonRule=function(e,t,o){return e.replace(t,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e[2]){for(var r=e[2].split(","),n=[],s=0;s<r.length;s++){var l=r[s].trim();if(!l)break;n.push(o(_polyfillHostNoCombinator,l,e[3]))}return n.join(",")}return _polyfillHostNoCombinator+e[3]})},colonHostPartReplacer=function(e,t,o){return e+t.replace(_polyfillHost,"")+o},convertColonHost=function(e){return convertColonRule(e,_cssColonHostRe,colonHostPartReplacer)},colonHostContextPartReplacer=function(e,t,o){return t.indexOf(_polyfillHost)>-1?colonHostPartReplacer(e,t,o):e+t+o+", "+t+" "+e+o},convertColonSlotted=function(e,t){var o="."+t+" > ",r=[];return e=e.replace(_cssColonSlottedRe,function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(e[2]){for(var n=e[2].trim(),s=e[3],l=o+n+s,c="",i=e[4]-1;i>=0;i--){var a=e[5][i];if("}"===a||","===a)break;c=a+c}var p=c+l,u=""+c.trimRight()+l.trim();if(p.trim()!==u.trim()){var f=u+", "+p;r.push({orgSelector:p,updatedSelector:f})}return l}return _polyfillHostNoCombinator+e[3]}),{selectors:r,cssText:e}},convertColonHostContext=function(e){return convertColonRule(e,_cssColonHostContextRe,colonHostContextPartReplacer)},convertShadowDOMSelectors=function(e){return _shadowDOMSelectorsRe.reduce(function(e,t){return e.replace(t," ")},e)},makeScopeMatcher=function(e){return e=e.replace(/\[/g,"\\[").replace(/\]/g,"\\]"),new RegExp("^("+e+")"+_selectorReSuffix,"m")},selectorNeedsScoping=function(e,t){return!makeScopeMatcher(t).test(e)},applySimpleSelectorScope=function(e,t,o){if(_polyfillHostRe.lastIndex=0,_polyfillHostRe.test(e)){var r="."+o;return e.replace(_polyfillHostNoCombinatorRe,function(e,t){return t.replace(/([^:]*)(:*)(.*)/,function(e,t,o,n){return t+r+o+n})}).replace(_polyfillHostRe,r+" ")}return t+" "+e},applyStrictSelectorScope=function(e,t,o){for(var r,n="."+(t=t.replace(/\[is=([^\]]*)\]/g,function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];return t[0]})),s=function(e){var r=e.trim();if(!r)return"";if(e.indexOf(_polyfillHostNoCombinator)>-1)r=applySimpleSelectorScope(e,t,o);else{var s=e.replace(_polyfillHostRe,"");if(s.length>0){var l=s.match(/([^:]*)(:*)(.*)/);l&&(r=l[1]+n+l[2]+l[3])}}return r},l=safeSelector(e),c="",i=0,a=/( |>|\+|~(?!=))\s*/g,p=!((e=l.content).indexOf(_polyfillHostNoCombinator)>-1);null!==(r=a.exec(e));){var u=r[1],f=e.slice(i,r.index).trim();c+=((p=p||f.indexOf(_polyfillHostNoCombinator)>-1)?s(f):f)+" "+u+" ",i=a.lastIndex}var _=e.substring(i);return c+=(p=p||_.indexOf(_polyfillHostNoCombinator)>-1)?s(_):_,restoreSafeSelector(l.placeholders,c)},scopeSelector=function(e,t,o,r){return e.split(",").map(function(e){return r&&e.indexOf("."+r)>-1?e.trim():selectorNeedsScoping(e,t)?applyStrictSelectorScope(e,t,o).trim():e.trim()}).join(", ")},scopeSelectors=function(e,t,o,r,n){return processRules(e,function(e){var n=e.selector,s=e.content;return"@"!==e.selector[0]?n=scopeSelector(e.selector,t,o,r):(e.selector.startsWith("@media")||e.selector.startsWith("@supports")||e.selector.startsWith("@page")||e.selector.startsWith("@document"))&&(s=scopeSelectors(e.content,t,o,r)),{selector:n.replace(/\s{2,}/g," ").trim(),content:s}})},scopeCssText=function(e,t,o,r,n){e=insertPolyfillHostInCssText(e),e=convertColonHost(e),e=convertColonHostContext(e);var s=convertColonSlotted(e,r);return e=s.cssText,e=convertShadowDOMSelectors(e),t&&(e=scopeSelectors(e,t,o,r)),{cssText:(e=(e=e.replace(/-shadowcsshost-no-combinator/g,"."+o)).replace(/>\s*\*\s+([^{, ]+)/gm," $1 ")).trim(),slottedSelectors:s.selectors}},scopeCss=function(e,t,o){var r=t+"-h",n=t+"-s",s=extractCommentsWithHash(e);e=stripComments(e);var l=[];if(o){var c=function(e){var t="/*!@___"+l.length+"___*/",o="/*!@"+e.selector+"*/";return l.push({placeholder:t,comment:o}),e.selector=t+e.selector,e};e=processRules(e,function(e){return"@"!==e.selector[0]?c(e):e.selector.startsWith("@media")||e.selector.startsWith("@supports")||e.selector.startsWith("@page")||e.selector.startsWith("@document")?(e.content=processRules(e.content,c),e):e})}var i=scopeCssText(e,t,r,n);return e=__spreadArrays([i.cssText],s).join("\n"),o&&l.forEach(function(t){var o=t.placeholder,r=t.comment;e=e.replace(o,r)}),i.slottedSelectors.forEach(function(t){e=e.replace(t.orgSelector,t.updatedSelector)}),e};export{scopeCss};